WITH BKPF AS (
    SELECT * FROM {{ ref('BKPF') }}
),
BSEG AS (
    SELECT * FROM {{ ref('BSEG') }}
),
J_3RKKRS AS (
    SELECT * FROM {{ ref('J_3RKKRS') }}
),
LFA1 AS (
    SELECT * FROM {{ ref('LFA1') }}
),
KNA1 AS (
    SELECT * FROM {{ ref('KNA1') }}
),
debit_entries AS (
    SELECT
        BKPF.BUDAT AS POSTING_DATE,
        BKPF.BLDAT AS DOC_DATE,
        BKPF.BELNR AS DOCUMENT_NO,
        BKPF.XBLNR AS INVOICE_NO,
        BKPF.BUKRS AS COMPANY_CODE,
        J_3RKKRS.WAERS AS CURRENCY_CODE,
        BSEG_D.PRCTR AS PROFIT_CENTRE,
        BSEG_D.KOSTL AS COST_CENTRE,
        COALESCE(NULLIF(BSEG_D.LIFNR,''), NULLIF(BSEG_D.KUNNR,'')) AS OBJECT_ID,
        COALESCE(NULLIF(BSEG_D.SGTXT,''), NULLIF(BKPF.BKTXT,'')) AS DESCRIPTION,
        J_3RKKRS.DEBET AS GL_ACCOUNT_NO,
        J_3RKKRS.KREDIT AS OFFSET_GL_ACCT,
        J_3RKKRS.BUZEID AS DOC_ITEM,
        J_3RKKRS.BUZEIK AS OFFSET_DOC_ITEM,
        CASE 
            WHEN J_3RKKRS.XNEGPD = '' THEN J_3RKKRS.DMBTR * 100
        END AS DEBIT_AMT,
        CASE
            WHEN J_3RKKRS.XNEGPD = 'X' THEN J_3RKKRS.DMBTR * 100
        END AS CREDIT_AMT,
        CASE 
            WHEN J_3RKKRS.XNEGPK = 'X' OR J_3RKKRS.XNEGPD = 'X' THEN J_3RKKRS.DMBTR * -100
            ELSE J_3RKKRS.DMBTR * 100
        END AS LOCAL_AMT,
        CASE WHEN BKPF.STBLG = '' THEN 0 ELSE 1 END AS IS_REVERSE,
        CASE WHEN DATEADD(day,1,EOMONTH(BKPF.BUDAT, -1)) = DATEADD(day,1,EOMONTH(REVERSE.BUDAT, -1)) THEN 1 ELSE 0 END AS IS_REVERSE_SP, -- Same period
        CASE WHEN J_3RKKRS.XNEGPD = 'X' THEN 1 ELSE 0 END AS IS_NEGATIVE_POSTING,

        CASE 
            WHEN J_3RKKRS.WAERS <> '{{ var("local_currency") }}' AND J_3RKKRS.XNEGPD = '' THEN J_3RKKRS.WRBTR
        END AS FX_DEBIT_AMT,
        CASE
            WHEN J_3RKKRS.WAERS <> '{{ var("local_currency") }}' AND J_3RKKRS.XNEGPD = 'X' THEN J_3RKKRS.WRBTR
        END AS FX_CREDIT_AMT,

        CASE WHEN J_3RKKRS.WAERS = '{{ var("local_currency") }}' THEN NULL ELSE J_3RKKRS.WRBTR END AS FX_AMT,
        CASE WHEN J_3RKKRS.WAERS = '{{ var("local_currency") }}' THEN NULL ELSE BKPF.KURSF * 1000 END AS FX_RATE,
        BSEG_D.KOART AS ACCOUNT_TYPE,
        BSEG_D.LIFNR AS VENDOR_CODE,
        BSEG_D.KUNNR AS CUSTOMER_CODE,
        N'Debit' AS DOC_TYPE
    FROM
        BKPF
        JOIN J_3RKKRS
            ON BKPF.MANDT = J_3RKKRS.MANDT
            AND BKPF.BELNR = J_3RKKRS.BELNR
            AND BKPF.BUKRS = J_3RKKRS.BUKRS
            AND BKPF.GJAHR = J_3RKKRS.GJAHR
        JOIN BSEG BSEG_D
            ON BSEG_D.MANDT = J_3RKKRS.MANDT
            AND BSEG_D.BUKRS = J_3RKKRS.BUKRS
            AND BSEG_D.BELNR = J_3RKKRS.BELNR
            AND BSEG_D.BUZEI = J_3RKKRS.BUZEID
        LEFT JOIN BKPF REVERSE
            ON BKPF.MANDT = REVERSE.MANDT
            AND BKPF.STBLG = REVERSE.BELNR
            AND BKPF.BUKRS = REVERSE.BUKRS
            AND BKPF.GJAHR = REVERSE.STJAH
    WHERE
        1 = 1
),
credit_entries AS (
    SELECT
        BKPF.BUDAT AS POSTING_DATE,
        BKPF.BLDAT AS DOC_DATE,
        BKPF.BELNR AS DOCUMENT_NO,
        BKPF.XBLNR AS INVOICE_NO,
        BKPF.BUKRS AS COMPANY_CODE,
        J_3RKKRS.WAERS AS CURRENCY_CODE,
        BSEG_K.PRCTR AS PROFIT_CENTRE,
        BSEG_K.KOSTL AS COST_CENTRE,
        COALESCE(NULLIF(BSEG_K.LIFNR,''), NULLIF(BSEG_K.KUNNR,'')) AS OBJECT_ID,
        COALESCE(NULLIF(BSEG_K.SGTXT,''), NULLIF(BKPF.BKTXT,'')) AS DESCRIPTION,
        J_3RKKRS.KREDIT AS GL_ACCOUNT_NO,
        J_3RKKRS.DEBET AS OFFSET_GL_ACCT,
        J_3RKKRS.BUZEIK AS DOC_ITEM,
        J_3RKKRS.BUZEID AS OFFSET_DOC_ITEM,
        CASE
            WHEN J_3RKKRS.XNEGPK = 'X' THEN J_3RKKRS.DMBTR * -100
        END AS DEBIT_AMT,
        CASE 
            WHEN J_3RKKRS.XNEGPK = '' THEN J_3RKKRS.DMBTR * -100
        END AS CREDIT_AMT,
        CASE 
            WHEN J_3RKKRS.XNEGPK = 'X' OR J_3RKKRS.XNEGPD = 'X' THEN J_3RKKRS.DMBTR * -100
            ELSE J_3RKKRS.DMBTR * 100
        END AS LOCAL_AMT,
        CASE WHEN BKPF.STBLG = '' THEN 0 ELSE 1 END AS IS_REVERSE,
        CASE WHEN DATEADD(day,1,EOMONTH(BKPF.BUDAT, -1)) = DATEADD(day,1,EOMONTH(REVERSE.BUDAT, -1)) THEN 1 ELSE 0 END AS IS_REVERSE_SP, -- Same period
        CASE WHEN J_3RKKRS.XNEGPK = 'X' THEN 1 ELSE 0 END AS IS_NEGATIVE_POSTING,

        CASE 
            WHEN J_3RKKRS.WAERS <> '{{ var("local_currency") }}' AND J_3RKKRS.XNEGPK = 'X' THEN J_3RKKRS.WRBTR * -1
        END AS FX_DEBIT_AMT,
        CASE
            WHEN J_3RKKRS.WAERS <> '{{ var("local_currency") }}' AND J_3RKKRS.XNEGPK = '' THEN J_3RKKRS.WRBTR * -1
        END AS FX_CREDIT_AMT,

        CASE WHEN J_3RKKRS.WAERS = '{{ var("local_currency") }}' THEN NULL ELSE J_3RKKRS.WRBTR END AS FX_AMT,
        CASE WHEN J_3RKKRS.WAERS = '{{ var("local_currency") }}' THEN NULL ELSE BKPF.KURSF * 1000 END AS FX_RATE,
        BSEG_K.KOART AS ACCOUNT_TYPE,
        BSEG_K.LIFNR AS VENDOR_CODE,
        BSEG_K.KUNNR AS CUSTOMER_CODE,
        N'Credit' AS DOC_TYPE
    FROM
        BKPF
        JOIN J_3RKKRS
            ON BKPF.MANDT = J_3RKKRS.MANDT
            AND BKPF.BELNR = J_3RKKRS.BELNR
            AND BKPF.BUKRS = J_3RKKRS.BUKRS
            AND BKPF.GJAHR = J_3RKKRS.GJAHR
        JOIN BSEG BSEG_K
            ON BSEG_K.MANDT = J_3RKKRS.MANDT
            AND BSEG_K.BUKRS = J_3RKKRS.BUKRS
            AND BSEG_K.BELNR = J_3RKKRS.BELNR
            AND BSEG_K.BUZEI = J_3RKKRS.BUZEIK
        LEFT JOIN BKPF REVERSE
            ON BKPF.MANDT = REVERSE.MANDT
            AND BKPF.STBLG = REVERSE.BELNR
            AND BKPF.BUKRS = REVERSE.BUKRS
            AND BKPF.GJAHR = REVERSE.STJAH
    WHERE
        1 = 1
),
non_offset AS (
-- SOME TRANSACTION CANNOT BE MAPPED WITH OFFSETING ACCOUNT
SELECT
    BKPF.BUDAT AS POSTING_DATE,
    BKPF.BLDAT AS DOC_DATE,
    BKPF.BELNR AS DOCUMENT_NO,
    BKPF.XBLNR AS INVOICE_NO,
    BKPF.BUKRS AS COMPANY_CODE,
    BKPF.WAERS AS CURRENCY_CODE,
    BSEG.PRCTR AS PROFIT_CENTRE,
    BSEG.KOSTL AS COST_CENTRE,
    COALESCE(NULLIF(BSEG.LIFNR,''), NULLIF(BSEG.KUNNR,'')) AS OBJECT_ID,
    COALESCE(NULLIF(BSEG.SGTXT,''), NULLIF(BKPF.BKTXT,'')) AS DESCRIPTION,
    BSEG.HKONT AS GL_ACCOUNT_NO,
    '' AS OFFSET_GL_ACCT,
    BSEG.BUZEI AS DOC_ITEM,
    '' AS OFFSET_DOC_ITEM,
    CASE
        WHEN BSEG.SHKZG = 'S' AND BSEG.XNEGP = '' THEN BSEG.DMBTR * 100
        WHEN BSEG.SHKZG = 'H' AND BSEG.XNEGP = 'X' THEN BSEG.DMBTR * -100
    END AS DEBIT_AMT,
    CASE
        WHEN BSEG.SHKZG = 'S' AND BSEG.XNEGP = 'X' THEN BSEG.DMBTR * 100
        WHEN BSEG.SHKZG = 'H' AND BSEG.XNEGP = '' THEN BSEG.DMBTR * -100
    END AS CREDIT_AMT,
    CASE 
        WHEN J_3RKKRS.XNEGPK = 'X' OR J_3RKKRS.XNEGPD = 'X' THEN J_3RKKRS.DMBTR * -100
        ELSE J_3RKKRS.DMBTR * 100
    END AS LOCAL_AMT,
    CASE WHEN BKPF.STBLG = '' THEN 0 ELSE 1 END AS IS_REVERSE,
    CASE WHEN DATEADD(day,1,EOMONTH(BKPF.BUDAT, -1)) = DATEADD(day,1,EOMONTH(REVERSE.BUDAT, -1)) THEN 1 ELSE 0 END AS IS_REVERSE_SP, -- Same period
    CASE WHEN BSEG.XNEGP = 'X' THEN 1 ELSE 0 END AS IS_NEGATIVE_POSTING,

    CASE
        WHEN J_3RKKRS.WAERS <> '{{ var("local_currency") }}' AND BSEG.SHKZG = 'S' AND BSEG.XNEGP = '' THEN BSEG.WRBTR * 1
        WHEN J_3RKKRS.WAERS <> '{{ var("local_currency") }}' AND BSEG.SHKZG = 'H' AND BSEG.XNEGP = 'X' THEN BSEG.WRBTR * -1
    END AS FX_DEBIT_AMT,
    CASE
        WHEN J_3RKKRS.WAERS <> '{{ var("local_currency") }}' AND BSEG.SHKZG = 'S' AND BSEG.XNEGP = 'X' THEN BSEG.WRBTR * 1
        WHEN J_3RKKRS.WAERS <> '{{ var("local_currency") }}' AND BSEG.SHKZG = 'H' AND BSEG.XNEGP = '' THEN BSEG.WRBTR * -1
    END AS FX_CREDIT_AMT,

    CASE WHEN BKPF.WAERS = '{{ var("local_currency") }}' THEN NULL ELSE BSEG.WRBTR END AS FX_AMT,
    CASE WHEN BKPF.WAERS = '{{ var("local_currency") }}' THEN NULL ELSE BKPF.KURSF * 1000 END AS FX_RATE,
    BSEG.KOART AS ACCOUNT_TYPE,
    BSEG.LIFNR AS VENDOR_CODE,
    BSEG.KUNNR AS CUSTOMER_CODE,
    NULL AS DOC_TYPE
FROM
    BKPF
    JOIN BSEG
        ON BKPF.MANDT = BSEG.MANDT
        AND BKPF.BELNR = BSEG.BELNR
        AND BKPF.BUKRS = BSEG.BUKRS
        AND BKPF.GJAHR = BSEG.GJAHR
    LEFT JOIN J_3RKKRS
        ON BKPF.MANDT = J_3RKKRS.MANDT
        AND BKPF.BELNR = J_3RKKRS.BELNR
        AND BKPF.BUKRS = J_3RKKRS.BUKRS
        AND BKPF.GJAHR = J_3RKKRS.GJAHR
    LEFT JOIN BKPF REVERSE
        ON BKPF.MANDT = REVERSE.MANDT
        AND BKPF.STBLG = REVERSE.BELNR
        AND BKPF.BUKRS = REVERSE.BUKRS
        AND BKPF.GJAHR = REVERSE.STJAH
WHERE
    J_3RKKRS.BELNR IS NULL
),
combined AS (
    SELECT * FROM debit_entries
    UNION ALL SELECT * FROM credit_entries
    UNION ALL SELECT * FROM non_offset
)
SELECT
    combined.*,
    COALESCE(
        NULLIF(CONCAT(LFA1.NAME2,LFA1.NAME3, LFA1.NAME4),''),
        NULLIF(LFA1.NAME1, ''),
        NULLIF(CONCAT(KNA1.NAME2,KNA1.NAME3, KNA1.NAME4),''),
        NULLIF(KNA1.NAME1, '')
    ) AS OBJECT_NAME,
    COALESCE(
        NULLIF(CONCAT(LFA1.NAME2,LFA1.NAME3, LFA1.NAME4),''),
        NULLIF(LFA1.NAME1, '')
    ) AS VENDOR_NAME,
    COALESCE(
        NULLIF(CONCAT(KNA1.NAME2,KNA1.NAME3, KNA1.NAME4),''),
        NULLIF(KNA1.NAME1, '')
    ) AS CUSTOMER_NAME
FROM
    combined
    LEFT JOIN LFA1
        ON combined.OBJECT_ID = LFA1.LIFNR
    LEFT JOIN KNA1
        ON combined.OBJECT_ID = KNA1.KUNNR
WHERE
    1 = 1