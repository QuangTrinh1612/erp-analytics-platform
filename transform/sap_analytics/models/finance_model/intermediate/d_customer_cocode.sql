WITH KNA1 AS (
    SELECT * FROM {{ ref('KNA1') }}
    WHERE SPRAS = '{{ var("language") }}'
),
KNB1 AS (
    SELECT * FROM {{ ref('KNB1') }}
),
KNBK AS (
    SELECT * FROM {{ ref('KNBK') }}
)
SELECT
    CONCAT_WS('-', CUSTOMER_CODE, COMPANY_CODE) AS CUSTOMER_COCODE,
    KNA1.KUNNR AS CUSTOMER_CODE,
    KNB1.BUKRS AS COMPANY_CODE,
    KNA1.NAME1 AS CUSTOMER_NAME,
    COALESCE(
        NULLIF(CONCAT(KNA1.NAME2,KNA1.NAME3, KNA1.NAME4),''),
        KNA1.NAME1
    ) AS CUSTOMER_FULL_NAME,
    KNA1.ANRED AS TITLE,
    KNA1.LAND1 AS COUNTRY_KEY,
    KNA1.STCEG AS VAT_REG_NO,
    KNA1.KTOKD AS ACC_GROUP_GROUP,
    KNA1.STRAS AS STREET,
    KNA1.TELF1 AS PHONE_NUMBER_1,
    KNA1.TELFX AS FAX_NUMBER,
    KNA1.TELF2 AS PHONE_NUMBER_2,
    KNBK.BANKL AS BANK_KEY,
    KNBK.BANKN AS BANK_ACCT_NO,
    KNBK.KOINH AS BACK_ACCT_HOLDER,
    KNA1.PSTLZ AS POSTAL_CODE,
    KNA1.ORT01 AS CITY,
    KNA1.STCD1 AS TAX_NUMBER,
    KNA1.MCOD1 AS SEARCH_TERM,
    KNB1.AKONT AS RECON_ACCT,
    KNB1.FDGRV AS CASH_MGMT_GRP
FROM KNA1
LEFT JOIN KNB1
    ON KNA1.MANDT = KNB1.MANDT
    AND KNA1.KUNNR = KNB1.KUNNR
LEFT JOIN KNBK
    ON KNA1.MANDT = KNBK.MANDT
    AND KNA1.KUNNR = KNBK.KUNNR